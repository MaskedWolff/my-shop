name: Ultimate Playlist Merge (Stable & Deduplicated)

on:
  push:
    paths:
      - 'my_playlist'   # Trigger when your playlist changes
  schedule:
    - cron: '*/2 * * * *'   # Runs every 2 minutes
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Download External Playlists
        shell: bash
        run: |
          echo "â¬‡ï¸ Downloading external playlists..."
          # Array of URLs and output filenames
          declare -A playlists=(
            ["external_jstar.m3u"]="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u"
            ["external_fancode.m3u"]="https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u"
            ["external_willow.m3u"]="https://raw.githubusercontent.com/abid58b/WillowLivePlaylist/refs/heads/main/willowlive.m3u"
            ["external_z5.m3u"]="https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u"
            ["external_sony.m3u"]="https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u"
            ["external_sonyliv.m3u"]="https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.m3u"
          )

          for file in "${!playlists[@]}"; do
            url="${playlists[$file]}"
            echo "Downloading $file from $url ..."
            curl -fsSL "$url" -o "$file" || echo "âš ï¸ Failed to download $file, skipping."
          done

      - name: Merge and Deduplicate Playlists
        shell: bash
        run: |
          echo "#EXTM3U" > merged_playlist.m3u
          declare -A seen

          # All playlists: external + your playlist
          files=(external_jstar.m3u external_fancode.m3u external_willow.m3u external_z5.m3u external_sony.m3u external_sonyliv.m3u my_playlist)

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸ File $file not found, skipping..."
              continue
            fi

            section_name=$(basename "$file" .m3u)
            echo "# --- $section_name ---" >> merged_playlist.m3u

            while IFS= read -r line; do
              [[ "$line" =~ ^#EXT ]] && echo "$line" >> merged_playlist.m3u && continue
              [[ -z "$line" ]] && continue
              if [[ -z "${seen[$line]}" ]]; then
                echo "$line" >> merged_playlist.m3u
                seen[$line]=1
              fi
            done < "$file"
          done

          echo "âœ… Merge complete. Your playlist + external playlists are merged and deduplicated."

      - name: Commit if Updated
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add merged_playlist.m3u
          if ! git diff --cached --quiet; then
            echo "ğŸ“ Changes detected. Committing updated merged playlist..."
            git commit -m "Auto-merge playlists (deduplicated)"
            git pull origin main --rebase || echo "âš ï¸ Pull failed, continuing..."
            git push origin main || echo "âš ï¸ Push failed"
          else
            echo "â„¹ï¸ No changes detected in merged_playlist.m3u"

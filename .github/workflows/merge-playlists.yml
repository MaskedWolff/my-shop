name: Ultimate Playlist Merge (Fast)

on:
  push:
    paths:
      - 'my_playlist'
  schedule:
    - cron: '*/2 * * * *'   # â± Runs every 2 minutes
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download External Playlists
        run: |
          set -e
          echo "â¬‡ï¸ Downloading external playlists..."
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u" -o external_jstar.m3u || echo "âš ï¸ JStar playlist failed"
          curl -fsSL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o external_fancode.m3u || echo "âš ï¸ Fancode playlist failed"
          curl -fsSL "https://raw.githubusercontent.com/abid58b/WillowLivePlaylist/refs/heads/main/willowlive.m3u" -o external_willow.m3u || echo "âš ï¸ Willow playlist failed"
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u" -o external_z5.m3u || echo "âš ï¸ Z5 playlist failed"
          curl -fsSL "https://raw.githubusercontent.com/himanshu-temp/m3u/refs/heads/main/sony.m3u" -o external_sony.m3u || echo "âš ï¸ Sony playlist failed"
          curl -fsSL "https://raw.githubusercontent.com/drmlive/sliv-live-events/refs/heads/main/sonyliv.m3u" -o external_sonyliv.m3u || echo "âš ï¸ Sonyliv playlist failed"

      - name: Merge Playlists Safely
        run: |
          echo "#EXTM3U" > merged_playlist.m3u
          echo "â¬‡ï¸ Merging external playlists..."
          for f in external_*.m3u; do
            [ -f "$f" ] && grep -hv "^#EXTM3U" "$f" >> merged_playlist.m3u || true
          done
          echo "â¬‡ï¸ Adding local playlist..."
          grep -hv "^#EXTM3U" my_playlist >> merged_playlist.m3u || true
          echo "ğŸ—‚ Removing duplicate URLs..."
          sort -u merged_playlist.m3u -o merged_playlist.m3u
          echo "âœ… Merge complete."

      - name: Commit if Updated
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add merged_playlist.m3u
          if ! git diff --cached --quiet; then
            echo "ğŸ“ Changes detected. Committing updated playlist..."
            git commit -m "Auto-merge my_playlist with remote playlists"
            git pull origin main --rebase
            git push origin main
          else
            echo "â„¹ï¸ No changes detected in merged_playlist.m3u"
          fi

      - name: Upload merged playlist artifact
        uses: actions/upload-artifact@v4
        with:
          name: merged-playlist
          path: merged_playlist.m3u
